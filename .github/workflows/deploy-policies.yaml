name: Deploy Azure Policies

on:
  push:
    branches:
      - main
    paths:
      - 'policies/**'
      - '.github/workflows/deploy-policies.yml'
  workflow_dispatch:

jobs:
  deploy-policies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Set Subscription
        run: |
          az account set --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          echo "Logged in successfully to subscription: $(az account show --query name -o tsv)"

      - name: Deploy Policy Definitions
        run: |
          echo "Deploying Azure Policy Definitions..."
          
          if [ ! -d "policies/definitions" ]; then
            echo "No policies/definitions directory found"
            exit 0
          fi
          
          for policy_file in policies/definitions/*.json; do
            if [ -f "$policy_file" ]; then
              policy_name=$(basename "$policy_file" .json)
              echo "Creating/Updating policy: $policy_name"
              
              az policy definition create \
                --name "$policy_name" \
                --rules "$(jq -c '.properties.policyRule' $policy_file)" \
                --params "$(jq -c '.properties.parameters // {}' $policy_file)" \
                --display-name "$(jq -r '.properties.displayName' $policy_file)" \
                --description "$(jq -r '.properties.description // ""' $policy_file)" \
                --mode "$(jq -r '.properties.mode // "All"' $policy_file)" \
                || echo "Policy may already exist"
            fi
          done

      - name: Assign Policies
        run: |
          echo "Assigning Azure Policies..."
          
          if [ ! -d "policies/assignments" ]; then
            echo "No policies/assignments directory found"
            exit 0
          fi
          
          for assignment_file in policies/assignments/*.json; do
            if [ -f "$assignment_file" ]; then
              assignment_name=$(basename "$assignment_file" .json)
              policy_name=$(jq -r '.policyDefinitionName' "$assignment_file")
              display_name=$(jq -r '.displayName' "$assignment_file")
              parameters=$(jq -c '.parameters // {}' "$assignment_file")
              
              policy_id="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/providers/Microsoft.Authorization/policyDefinitions/$policy_name"
              
              az policy assignment create \
                --name "$assignment_name" \
                --display-name "$display_name" \
                --policy "$policy_id" \
                --params "$parameters" \
                --scope "/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}" \
                || echo "Assignment may already exist"
            fi
          done

      - name: Summary
        run: |
          echo "âœ… Deployment completed"
          az policy definition list --query "
