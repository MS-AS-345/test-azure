name: Deploy Azure Policies

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-policies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Verify Login
        run: |
          az account show
          echo "Logged in successfully!"

      - name: Deploy Policy Definitions
        run: |
          echo "Deploying policies..."
          if [ -d "policies/definitions" ]; then
            for policy_file in policies/definitions/*.json; do
              if [ -f "$policy_file" ]; then
                policy_name=$(basename "$policy_file" .json)
                echo "Processing: $policy_name"
                
                az policy definition create \
                  --name "$policy_name" \
                  --rules "$(jq -c '.properties.policyRule' $policy_file)" \
                  --params "$(jq -c '.properties.parameters // {}' $policy_file)" \
                  --display-name "$(jq -r '.properties.displayName' $policy_file)" \
                  --mode "$(jq -r '.properties.mode // "All"' $policy_file)" \
                  || echo "Policy may already exist"
              fi
            done
          fi

      - name: Summary
        run: |
          echo "âœ… Done!"
          az policy definition list --query "
